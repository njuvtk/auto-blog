name: Initialize Hexo with Anzhiyu Theme

# 触发条件：手动触发
on:
  workflow_dispatch:

jobs:
  init-hexo-anzhiyu:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出当前仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置Node.js环境
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      # 3. 全局安装Hexo CLI
      - name: Install Hexo CLI
        run: npm install -g hexo-cli

      # 4. 处理目录（解决hexo init要求空目录的问题）
      - name: Hexo init
        run: |
          mkdir -p temp
          cd temp
          hexo init .
          cd ..
          mv temp/* . || echo "No files to restore"
          rm -rf temp
          npm install

      # 5. 克隆Anzhiyu主题到themes/anzhiyu目录
      - name: Clone Anzhiyu theme
        run: git clone -b main https://github.com/anzhiyu-c/hexo-theme-anzhiyu.git themes/anzhiyu

      # 6. 配置Hexo使用Anzhiyu主题
      - name: Configure Hexo to use Anzhiyu theme
        run: |
          # 修改根目录_config.yml的theme字段（从landscape改为anzhiyu）
          sed -i 's/theme: landscape/theme: anzhiyu/g' _config.yml
          # 复制主题配置文件到根目录（方便自定义）
          cp themes/anzhiyu/_config.yml _config.anzhiyu.yml

      # 7. 安装Anzhiyu主题所需的依赖
      - name: Install theme dependencies
        run: |
          npm install --save \
            hexo-renderer-pug \
            hexo-renderer-stylus \
            hexo-component-inferno \
            hexo-generator-searchdb \
            hexo-generator-feed \
            hexo-generator-sitemap

      # 8. 配置Git用户信息
      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # 9. 提交并推送源码到当前仓库
      - name: Commit and push changes
        run: |
          git add .
          # 若没有修改则跳过提交
          git commit -m "Initialize Hexo with Anzhiyu theme via GitHub Action" || echo "No changes to commit"
          # 推送到当前分支
          git push origin ${{ github.ref }}
