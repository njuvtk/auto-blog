name: Initialize Hexo with Anzhiyu Theme

# 触发条件：手动触发（推荐，避免每次push都执行）
on:
  workflow_dispatch:

# 工作流配置
jobs:
  init-hexo-anzhiyu:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出当前仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置Node.js环境（Hexo推荐Node.js 16+/18+）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm' # 缓存npm依赖，加速后续运行

      # 3. 全局安装Hexo CLI
      - name: Install Hexo CLI
        run: npm install -g hexo-cli

      # 4. 处理目录（解决hexo init要求空目录的问题）
      - name: Prepare empty directory for Hexo init
        run: |
          # 创建临时目录存放现有文件（如.github/workflows）
          mkdir -p temp_repo
          # 移动当前目录所有文件（除.git和temp_repo）到临时目录
          shopt -s extglob
          mv !(temp_repo|.git) temp_repo/ || echo "No files to move"
          # 初始化Hexo到当前目录
          hexo init .
          # 把临时目录的文件移回当前目录（保留Workflow等文件）
          mv temp_repo/* . || echo "No files to restore"
          # 删除临时目录
          rm -rf temp_repo

      # 5. 克隆Anzhiyu主题到themes/anzhiyu目录
      - name: Clone Anzhiyu theme
        run: git clone https://github.com/anzhiyu-c/hexo-theme-anzhiyu.git themes/anzhiyu

      # 6. 配置Hexo使用Anzhiyu主题
      - name: Configure Hexo to use Anzhiyu theme
        run: |
          # 修改根目录_config.yml的theme字段（从landscape改为anzhiyu）
          sed -i 's/theme: landscape/theme: anzhiyu/g' _config.yml
          # 复制主题配置文件到根目录（方便自定义，不修改主题源码）
          cp themes/anzhiyu/_config.yml _config.anzhiyu.yml

      # 7. 安装Anzhiyu主题所需的依赖
      - name: Install theme dependencies
        run: |
          npm install --save \
            hexo-renderer-pug \
            hexo-renderer-stylus \
            hexo-component-inferno \
            hexo-generator-searchdb \
            hexo-generator-feed \
            hexo-generator-sitemap

      # 8. 配置Git用户信息（用于提交代码）
      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # 9. 提交并推送源码到当前仓库
      - name: Commit and push changes
        run: |
          git add .
          # 若没有修改则跳过提交（避免报错）
          git commit -m "Initialize Hexo with Anzhiyu theme via GitHub Action" || echo "No changes to commit"
          # 推送到当前分支
          git push origin ${{ github.ref }}
